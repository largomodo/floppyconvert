# Floppy Conversion Tool - Code Index

| File | What | When |
|------|------|------|
| `pom.xml` | Maven build configuration: Java 21, JUnit 5, Commons Exec, Picocli 4.7.7, SLF4J API, Logback Classic dependencies, two-section resource filtering (filtered floppyconvert.properties, non-filtered binary .img templates) | Modifying dependencies, build settings, JAR manifest, or resource filtering behavior |
| `src/main/resources/floppyconvert.properties` | Maven-filtered properties: application.name, application.version, application.url for Picocli resourceBundle | Changing CLI metadata displayed in --help, debugging missing property injection |
| `src/main/java/de/nrq/floppyconvert/FloppyConvert.java` | CLI entry point: Picocli-based argument parsing with @Command/@Parameters/@Option annotations, resourceBundle for dynamic metadata injection (${bundle:application.name}), SLF4J Logger, MDC context management, --verbose flag for DEBUG level, automatic help generation, smart defaults for output directory (. for files, input/output for directories), single positional input parameter replaces --input-file/--input-dir, SnesRomMatcher::isRom batch filter (replaces .sfc hardcoded filter), single-file validation rejects non-ROM formats, no --empty-image option (template bundled as JAR resource), no --mtools-path option (native FAT12 engine), implements Callable<Integer> | Adding CLI arguments, changing argument defaults, debugging argument validation, understanding Picocli pattern, modifying log verbosity behavior, debugging multi-format support |
| `src/main/resources/logback.xml` | Logback configuration: three appenders (STDOUT, FILE, FAILURES), MDC pattern %X{rom} for thread context, INFO default level | Modifying log output format, changing log levels, debugging logging issues |
| `src/main/java/de/nrq/floppyconvert/core/CopierFormat.java` | Enum for backup unit formats (FIG/SWC/UFO/GD3) with ucon64 command flags | Adding new format support or changing format-specific behavior |
| `src/main/java/de/nrq/floppyconvert/core/FloppyType.java` | Enum for floppy disk formats (720KB/1.44MB/1.6MB) with capacity limits and bestFit() selection logic | Adding new disk format or debugging capacity errors |
| `src/main/java/de/nrq/floppyconvert/core/DiskTemplateFactory.java` | Interface for floppy disk template providers | Adding alternative template sources or understanding template abstraction |
| `src/main/java/de/nrq/floppyconvert/core/ResourceDiskTemplateFactory.java` | Loads floppy disk templates from JAR classpath resources | Debugging template loading failures or modifying resource paths |
| `src/main/java/de/nrq/floppyconvert/core/RomPartComparator.java` | Universal comparator for ROM part sorting (numeric extensions, UFO .gm extensions with numeric prefix extraction, alphanumeric filenames) | Debugging sort order issues or extending to new naming patterns |
| `src/main/java/de/nrq/floppyconvert/core/RomPartNormalizer.java` | Stateless utility for ROM part filename sanitization and metadata generation | Debugging filename sanitization issues, shell compatibility problems, or understanding metadata creation |
| `src/main/java/de/nrq/floppyconvert/core/RomProcessor.java` | ROM processing pipeline orchestrator with DI, SLF4J logger for status output, ~235 lines, coordinates DiskPacker/RomSplitter/FloppyImageWriter/DiskTemplateFactory/RomPartNormalizer via ConversionWorkspace, includes output directory structure handling and interrupt-safe cleanup | Changing disk spanning logic, debugging DOS name collisions, modifying pipeline flow, understanding orchestration pattern, troubleshooting dependency injection |
| `src/main/java/de/nrq/floppyconvert/core/domain/RomPartMetadata.java` | Domain record for ROM part metadata (path, size, DOS name) with null validation | Understanding DiskPacker input format, debugging validation errors |
| `src/main/java/de/nrq/floppyconvert/core/domain/DiskLayout.java` | Domain record for disk contents and floppy type | Understanding DiskPacker output format |
| `src/main/java/de/nrq/floppyconvert/core/domain/DiskPacker.java` | Bin-packing algorithm interface | Adding alternative packing strategies |
| `src/main/java/de/nrq/floppyconvert/core/domain/GreedyDiskPacker.java` | First-fit decreasing bin-packing implementation | Debugging disk capacity issues or modifying packing algorithm |
| `src/main/java/de/nrq/floppyconvert/core/workspace/ConversionWorkspace.java` | AutoCloseable workspace for artifact tracking and cleanup with interrupt flag handling, SLF4J logger for warnings; thread-safe when each instance confined to single thread (no shared workspace directories) | Understanding resource management pattern, debugging cleanup issues, troubleshooting interrupt behavior, understanding promoteToFinal atomic move pattern |
| `src/main/java/de/nrq/floppyconvert/core/ConversionObserver.java` | Observer interface for batch processing events | Adding progress monitoring or telemetry |
| `src/main/java/de/nrq/floppyconvert/service/RomSplitter.java` | Interface for ROM splitting adapters | Adding alternative ROM splitting tools |
| `src/main/java/de/nrq/floppyconvert/service/NativeRomSplitter.java` | Native Java ROM splitter: orchestrates SnesRomReader, SnesInterleaver, HeaderGeneratorFactory for split file generation, 4Mbit chunks (SWC/FIG/UFO) or 8Mbit chunks (GD3), conditional GD3 HiROM interleaving, FileChannel I/O, format-specific naming (FIG/SWC: .1/.2, UFO: .1gm/.2gm, GD3: SF-Code with .078 extension), stateless service implementing RomSplitter interface | Debugging split boundaries, changing chunk sizes, understanding interleaving logic, troubleshooting file I/O, understanding GD3 SF-Code naming conventions |
| `src/main/java/de/nrq/floppyconvert/service/FloppyImageWriter.java` | Interface for floppy image injection adapters | Adding alternative floppy image tools |
| `src/main/java/de/nrq/floppyconvert/service/ExternalProcessDriver.java` | Base class for external process execution with timeout and exit code validation | Changing timeout behavior, process error handling, or adding new external tools |
| `src/main/java/de/nrq/floppyconvert/service/Ucon64Driver.java` | Wrapper for ucon64 ROM splitting: work-in-place with absolute path input, SLF4J logger for warnings, automatic retry (4→12 Mbit escalation), intermediate file cleanup after split, format parameter, and filter-based discovery | Changing ucon64 command-line flags, understanding two-step conversion cleanup, split file discovery logic, or retry behavior |
| `src/main/java/de/nrq/floppyconvert/service/fat/Fat12ImageWriter.java` | Native Java FAT12 image writer: memory-mapped I/O, little-endian ByteBuffer, BPB parsing, cluster chaining, FAT mirroring | Debugging FAT12 write operations, understanding native implementation |
| `src/main/java/de/nrq/floppyconvert/snes/SnesRom.java` | Immutable domain record for SNES ROM metadata: RomType (LoROM/HiROM/ExHiROM), SRAM size, DSP flag, title, checksum fields, rawData byte array, isHiRom() helper method, null validation in compact record form | Understanding ROM metadata structure, debugging header parsing, validating ROM integrity |
| `src/main/java/de/nrq/floppyconvert/snes/RomType.java` | Enum for SNES memory map types: LoROM (0x7FB0 header), HiROM (0xFFB0 header), ExHiROM (0x40FFB0 header) | Adding new ROM types, understanding header location mapping |
| `src/main/java/de/nrq/floppyconvert/snes/SnesRomReader.java` | SNES ROM parser: strips 512-byte copier headers, probes internal header locations (0x7FB0/0xFFB0/0x40FFB0), weighted scoring algorithm for type detection, extracts metadata (title, SRAM, DSP, checksum), validates checksum+complement=0xFFFF, returns SnesRom record | Debugging ROM detection failures, understanding scoring weights, adding new header locations, troubleshooting checksum validation |
| `src/main/java/de/nrq/floppyconvert/snes/SnesInterleaver.java` | GD3 HiROM interleaver: pads to 8Mbit boundaries with 0x00, swaps 32KB blocks within 64KB chunks (16 blocks per 8Mbit), stateless service, returns new byte array (non-destructive) | Debugging GD3 interleaving, understanding block swapping logic, troubleshooting padding behavior |
| `src/main/java/de/nrq/floppyconvert/snes/header/HeaderGenerator.java` | Interface for copier format header generation: generateHeader(SnesRom, partSize, splitPartIndex, isLastPart) returns byte[512] or empty byte[], partSize parameter provides per-part ROM data size for block calculations (SWC/FIG/UFO use partSize, GD3 ignores it, UFO uses partSize for bytes 0-1 but total ROM size for byte 17) | Adding new copier formats, understanding header generation contract, understanding partSize parameter usage |
| `src/main/java/de/nrq/floppyconvert/snes/header/HeaderGeneratorFactory.java` | Factory for format-specific header generators: returns SwcHeaderGenerator, FigHeaderGenerator, UfoHeaderGenerator, or Gd3HeaderGenerator based on CopierFormat | Adding new format support, debugging generator selection |
| `src/main/java/de/nrq/floppyconvert/snes/header/SwcHeaderGenerator.java` | SWC copier header generator: emulation mode (0x30 HiROM/0x00 LoROM), SRAM size encoding (0x0C/0x08/0x04/0x00), multi-file flag (0x40), fixed IDs (0xAA/0xBB/0x04), size in 8KB blocks calculated from partSize parameter | Debugging SWC headers, understanding SRAM encoding, troubleshooting emulation flags, understanding partSize usage |
| `src/main/java/de/nrq/floppyconvert/snes/header/FigHeaderGenerator.java` | FIG copier header generator: HiROM flag (0x80), multi-file flag (0x40), emulation bytes with DSP logic, headers on all parts (not just first), size in 8KB blocks calculated from partSize parameter | Debugging FIG headers, understanding DSP flag encoding, troubleshooting multi-part behavior, understanding partSize usage |
| `src/main/java/de/nrq/floppyconvert/snes/header/UfoHeaderGenerator.java` | UFO copier header generator: "SUPERUFO" ID string, bank type (0 HiROM/1 LoROM), SRAM size codes (0/1/2/3/8), SRAM mapping controls (A15, A20-A23), dual-source size encoding (partSize for bytes 0-1, total ROM size for byte 17) | Debugging UFO headers, understanding SRAM mapping logic, troubleshooting bank type selection, understanding dual-source size requirement |
| `src/main/java/de/nrq/floppyconvert/snes/header/Gd3HeaderGenerator.java` | GD3 copier header generator: "GAME DOCTOR SF 3" ID, first-part-only headers (empty byte[] for parts > 0), memory map table selection based on total ROM size (partSize parameter ignored), memory map tables (8MB/16MB/24MB/32MB HiROM, 4MB/8MB/16MB/32MB LoROM), HiROM SRAM mapping (0x29/0x2A), LoROM DSP and SRAM mapping (0x14/0x1C/0x24/0x28) | Debugging GD3 headers, understanding memory map tables, troubleshooting SRAM/DSP mapping, understanding why partSize is ignored |
| `src/main/java/de/nrq/floppyconvert/snes/README.md` | Architecture overview: staged pipeline (read, interleave, split, write), data flow diagrams, design rationale (immutable records, separation of concerns, factory pattern), invariants (checksum validation, 8Mbit alignment, header consistency, interleaving is destructive) | Understanding SNES conversion architecture, reviewing design decisions, troubleshooting pipeline issues |
| `src/main/java/de/nrq/floppyconvert/snes/header/README.md` | Header format specifications: format-specific quirks (FIG headers on all parts, GD3 first-part-only, 8Mbit alignment), SRAM encoding tables, memory map selection logic, DSP flag handling, partSize parameter usage documentation | Understanding copier format differences, debugging header generation issues, adding new format support, understanding per-part vs total ROM size usage |
| `src/main/java/de/nrq/floppyconvert/service/README.md` | Split pipeline architecture: data flow diagrams, format-specific naming conventions (FIG/SWC .1/.2, UFO .1gm/.2gm, GD3 SF-Code), GD3 X-padding edge cases, dual-source size encoding rationale (UFO), design tradeoffs (inline naming vs extraction, per-part size parameter) | Understanding ROM splitting architecture, debugging GD3 SF-Code naming, understanding format-specific naming decisions, troubleshooting split pipeline issues |
| `src/main/java/de/nrq/floppyconvert/util/DosNameUtil.java` | DOS 8.3 filename sanitization logic | Changing filename truncation, special character handling, or extension preservation |
| `src/main/java/de/nrq/floppyconvert/util/SnesRomMatcher.java` | SNES ROM format detection: static utility with isRom(Path) method, supports extensions (.sfc, .fig, .smw, .swc, .ufo, .1) and Game Doctor naming via regex, Files.isRegularFile check to prevent directory false positives | Adding new ROM format support, debugging format detection, understanding batch filter logic |
| `src/main/java/de/nrq/floppyconvert/util/README.md` | Architecture rationale: static utility pattern (vs DI), hybrid detection strategy (extension Set + Game Doctor regex), hardcoded extensions (vs configuration), invariants (null safety, case-insensitivity, directory prevention) | Understanding utility layer design decisions, reviewing tradeoffs |
| `src/test/java/de/nrq/floppyconvert/core/RomPartComparatorTest.java` | Test cases for universal ROM part sorting (numeric extensions, UFO .gm extensions, alphanumeric filenames) | Verifying sort behavior for new format or edge cases |
| `src/test/java/de/nrq/floppyconvert/util/DosNameUtilTest.java` | Test cases for DOS naming edge cases | Adding new filename sanitization scenarios |
| `src/test/java/de/nrq/floppyconvert/util/SnesRomMatcherTest.java` | Test cases for SNES ROM detection: standard extensions, case sensitivity, Game Doctor formats, edge cases (null, directories, nonexistent) | Verifying ROM detection behavior, adding new format test cases |
| `src/test/java/de/nrq/floppyconvert/util/TestUcon64PathResolver.java` | Test utility for ucon64 binary path resolution: checks PATH first, falls back to classpath resource /ucon64 | Updating test setup, adding new tests requiring ucon64, debugging test skips |
| `src/test/resources/logback-test.xml` | Test logging config: WARN threshold to suppress test noise | Debugging test log output |
| `src/test/java/de/nrq/floppyconvert/FloppyConvertTest.java` | Test cases for CLI argument parsing: positional parameters, smart output defaults, enum parsing, validation | Verifying Picocli argument handling, testing CLI behavior |
| `src/test/java/de/nrq/floppyconvert/FloppyConvertLoggingTest.java` | Test cases for logging: verbose flag, MDC context propagation, failures appender | Verifying logging behavior |
| `src/test/java/de/nrq/floppyconvert/service/Ucon64DriverTest.java` | Test cases for ucon64 process execution: command-line arguments, retry mechanism (4→12 Mbit), error handling | Verifying ucon64 command-line arguments, timeout behavior, or retry logic for large ROMs |
| `src/test/java/de/nrq/floppyconvert/service/NativeRomSplitterTest.java` | Integration tests for NativeRomSplitter with mocked dependencies: split boundary calculations, file naming for all formats (FIG/SWC .1/.2, UFO .1gm/.2gm, GD3 .078), conditional interleaving (GD3+HiROM only), header generation delegation | Verifying split logic, format-specific naming, interleaving behavior |
| `src/test/java/de/nrq/floppyconvert/service/fat/Fat12ImageWriterTest.java` | Unit tests for native FAT12 writer: cluster allocation, FAT mirroring, directory entries, disk full scenarios | Verifying FAT12 operations, adding test cases for edge cases |
| `src/test/java/de/nrq/floppyconvert/core/domain/RomPartMetadataTest.java` | Unit tests for RomPartMetadata record: validation, immutability | Verifying domain record behavior |
| `src/test/java/de/nrq/floppyconvert/core/domain/DiskLayoutTest.java` | Unit tests for DiskLayout record: immutability, list wrapping | Verifying domain record behavior |
| `src/test/java/de/nrq/floppyconvert/core/domain/GreedyDiskPackerTest.java` | Unit tests for bin-packing algorithm: empty input, single disk, multi-disk spanning, oversized parts | Debugging packing behavior or adding test cases |
| `src/test/java/de/nrq/floppyconvert/core/workspace/ConversionWorkspaceTest.java` | Unit tests for workspace cleanup: tracked files, final outputs, nested directories, Windows locking | Debugging cleanup issues or validating AutoCloseable contract |
| `src/test/java/de/nrq/floppyconvert/core/RomProcessorTest.java` | Unit tests for RomProcessor with mocked dependencies: delegation, exception handling, workspace cleanup | Debugging orchestration logic without external tools |
| `src/test/java/de/nrq/floppyconvert/FloppyConvertConcurrencyTest.java` | Integration tests for concurrent batch processing: workspace isolation, observer thread-safety, graceful shutdown | Debugging concurrency issues or validating thread pool behavior |
| `src/test/java/de/nrq/floppyconvert/FloppyConvertE2ETest.java` | E2E tests for full conversion pipeline across all formats (FIG/SWC/UFO/GD3) with real ROM files | Debugging conversion failures, adding new format support, validating pipeline changes |
| `src/test/java/de/nrq/floppyconvert/FloppyConvertRecursionTest.java` | Integration tests for recursive directory traversal: deep nesting, sibling directories, root-level files, symlink behavior | Debugging structure preservation, verifying recursive traversal behavior, validating path mirroring |
| `src/test/java/de/nrq/floppyconvert/snes/header/SwcHeaderGeneratorTest.java` | Property-based tests for SWC header generation: partSize parameter validation, emulation mode encoding, SRAM size encoding, multi-file flags, block count calculations | Verifying SWC header correctness, adding test cases for edge cases |
| `src/test/java/de/nrq/floppyconvert/snes/header/FigHeaderGeneratorTest.java` | Property-based tests for FIG header generation: partSize parameter validation, HiROM flags, multi-file flags, DSP encoding in emulation bytes, block count calculations | Verifying FIG header correctness, adding test cases for edge cases |
| `src/test/java/de/nrq/floppyconvert/snes/header/UfoHeaderGeneratorTest.java` | Property-based tests for UFO header generation: partSize parameter validation, dual-source size encoding (partSize for bytes 0-1, total size for byte 17), SRAM mapping controls, bank type encoding | Verifying UFO header correctness, dual-source requirement, adding test cases for edge cases |
| `src/test/java/de/nrq/floppyconvert/snes/header/Gd3HeaderGeneratorTest.java` | Property-based tests for GD3 header generation: partSize parameter ignored (uses total ROM size), first-part-only headers, memory map table selection, SRAM/DSP mapping | Verifying GD3 header correctness, first-part-only behavior, adding test cases for edge cases |
| `src/test/java/de/nrq/floppyconvert/snes/header/HeaderGeneratorFactoryTest.java` | Unit tests for HeaderGeneratorFactory: format-based generator selection, returns correct generator instances for each CopierFormat | Verifying factory logic, adding new format support |
| `src/test/java/de/nrq/floppyconvert/snes/README.md` | Testing strategy documentation: property-based testing with jqwik, synthetic ROM generation, test coverage approach (unit tests for Phases 1-3, mocked integration tests for NativeRomSplitter, E2E tests with real ROMs), property design rationale | Understanding SNES test architecture, adding new test cases, debugging property-based tests |
| `README.md` | Architecture overview, format-specific naming examples (FIG/SWC .1/.2, UFO .1gm/.2gm, GD3 SF-Code), invisible knowledge rationale (native splitting, dual-source encoding, X-padding quirks, first-part-only headers), build instructions | Understanding system design, format-specific naming conventions, architectural rationale, running the tool |
| `PRELIMINARY-IMPLEMENTATION-PLAN.md` | Original design specification | Understanding historical context or design rationale |
| `implementation-plan-floppy-conversion.md` | Detailed implementation plan with milestones | Understanding implementation strategy or reviewing decisions |
| `implementation-plan-floppy-conversion-extension-ANNOTATED.md` | Multi-format extension plan with decision rationale | Understanding multi-format feature design or reviewing tradeoffs |
